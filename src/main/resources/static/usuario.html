<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Perfil de Usuario</title>
    <link rel="stylesheet" href="estructure.css">
    <link rel="stylesheet" href="usuario.css">

</head>
<body>
<aside>
    <!-- Esta secci√≥n se rellenar√° con sidebar.js -->
    <a class="user__container" href="usuario.html" id="sidebar-user-link">
        <div class="avatar" id="sidebar-avatar">
            <!-- El JS reemplazar√° esto -->
            <ion-icon class="user__icon" name="person-sharp"></ion-icon>
        </div>
        <span id="sidebar-user-name">Supervisor</span>
        <span id="sidebar-user-role" class="sidebar-user-role"></span>
    </a>
    <!-- Esta secci√≥n se rellenar√° con sidebar.js -->
    <div class="nav__container" id="sidebar-nav-links">
        <!-- Links por defecto (por si JS falla) -->
        <a class="section" href="portal-admin.html">
            <ion-icon name="bar-chart-outline"></ion-icon>
            Estad√≠sticas
        </a>
        <a class="section" href="agregar-misiones.html">
            <ion-icon name="add-circle-outline"></ion-icon>
            Gestionar Misiones
        </a>
        <a class="section" href="agregar-empleado.html">
            <ion-icon name="person-add-outline"></ion-icon>
            Gestionar Empleados
        </a>
    </div>
    <div>
        <a class="section logout" href="index.html" id="logout-button">
            <ion-icon name="log-out-outline"></ion-icon>
            Cerrar Sesi√≥n
        </a>
    </div>
</aside>

<main>
    <section class="user-profile__container">
        <div class="user-avatar">
            <div class="img__container">
                <img src="https://images.icon-icons.com/2483/PNG/512/user_icon_149851.png" alt="Avatar de usuario" id="profile-img">
            </div>
            <input type="text" id="edit-fotoUrl" class="edit-field" style="display: none; margin-top: 10px; text-align: center;" placeholder="Nueva URL de Foto">

            <h2 id="profile-name">...</h2>
            <p id="profile-role">...</p>

            <div id="edit-buttons-container">
                <button class="btn-edit" id="btn-start-edit">Editar Perfil</button>
                <button class="btn-save" id="btn-save-edit" style="display: none;">Guardar Cambios</button>
                <button class="btn-cancel" id="btn-cancel-edit" style="display: none;">Cancelar</button>
            </div>
        </div>

        <div class="user-info__grid">
            <div class="user-card">
                <h3>Datos Personales</h3>
                <div class="data-item">
                    <p><strong>Nombre:</strong> <span id="data-nombre">...</span></p>
                    <input type="text" id="edit-nombre" class="edit-field" style="display: none;">
                </div>
                <div class="data-item">
                    <p><strong>Apellido:</strong> <span id="data-apellido">...</span></p>
                    <input type="text" id="edit-apellido" class="edit-field" style="display: none;">
                </div>
                <div class="data-item">
                    <p><strong>DNI:</strong> <span id="data-dni">...</span></p>
                </div>
                <div class="data-item">
                    <p><strong>Nacimiento:</strong> <span id="data-nacimiento">...</span></p>
                    <div class="edit-container" style="display: none;">
                        <input type="date" id="edit-nacimiento" class="edit-field">
                        <button class="btn-clear" data-input="nacimiento">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="data-item">
                    <p><strong>Tel√©fono:</strong> <span id="data-telefono">...</span></p>
                    <div class="edit-container" style="display: none;">
                        <input type="tel" id="edit-telefono" class="edit-field" pattern="[0-9]{9,15}" title="Debe contener de 9 a 15 d√≠gitos">
                        <button class="btn-clear" data-input="telefono">üóëÔ∏è</button>
                    </div>
                </div>
            </div>

            <div class="user-card">
                <h3>Datos Laborales</h3>
                <div class="data-item">
                    <p><strong>Correo:</strong> <span id="data-correo">...</span></p>
                </div>
                <div class="data-item">
                    <p><strong>Puesto:</strong> <span id="data-puesto">...</span></p>
                    <input type="text" id="edit-puesto" class="edit-field" style="display: none;">
                </div>
                <div class="data-item">
                    <p><strong>Estado:</strong> <span id="data-estado">...</span></p>
                </div>
            </div>

            <div class="user-card">
                <h3>Informaci√≥n del Contrato</h3>
                <div class="data-item">
                    <p><strong>Ingreso:</strong> <span id="data-ingreso">...</span></p>
                </div>
                <div class="data-item">
                    <p><strong>Tiempo:</strong> <span id="data-tiempo">...</span></p>
                    <input type="text" id="edit-tiempo" class="edit-field" style="display: none;">
                </div>
                <div class="data-item">
                    <p><strong>Contrato:</strong> <span id="data-contrato">...</span></p>
                    <input type="text" id="edit-contrato" class="edit-field" style="display: none;">
                </div>
            </div>
        </div>
    </section>
</main>
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<script src="sidebar.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // --- 1. OBTENER USUARIO Y REFERENCIAS ---
        const usuarioJSON = sessionStorage.getItem("usuarioLogueado");
        if (!usuarioJSON) {
            // sidebar.js ya maneja la redirecci√≥n si no hay usuario
            return;
        }
        let usuario = JSON.parse(usuarioJSON);

        // Referencias a elementos de visualizaci√≥n (spans) en <main>
        const spans = {
            profileName: document.getElementById("profile-name"),
            profileRole: document.getElementById("profile-role"),
            profileImg: document.getElementById("profile-img"),
            nombre: document.getElementById("data-nombre"),
            apellido: document.getElementById("data-apellido"),
            // fullName: document.getElementById("data-full-name"), // ID ya no usado, usamos nombre/apellido
            dni: document.getElementById("data-dni"),
            nacimiento: document.getElementById("data-nacimiento"),
            telefono: document.getElementById("data-telefono"),
            correo: document.getElementById("data-correo"),
            puesto: document.getElementById("data-puesto"),
            estado: document.getElementById("data-estado"),
            ingreso: document.getElementById("data-ingreso"),
            tiempo: document.getElementById("data-tiempo"),
            contrato: document.getElementById("data-contrato")
        };

        // Referencias a elementos de edici√≥n (inputs) en <main>
        const inputs = {
            nombre: document.getElementById("edit-nombre"),
            apellido: document.getElementById("edit-apellido"),
            nacimiento: document.getElementById("edit-nacimiento"),
            telefono: document.getElementById("edit-telefono"),
            puesto: document.getElementById("edit-puesto"),
            tiempo: document.getElementById("edit-tiempo"),
            contrato: document.getElementById("edit-contrato"),
            fotoUrl: document.getElementById("edit-fotoUrl")
        };

        // Botones en <main>
        const btnStartEdit = document.getElementById("btn-start-edit");
        const btnSaveEdit = document.getElementById("btn-save-edit");
        const btnCancelEdit = document.getElementById("btn-cancel-edit");
        const btnClearFields = document.querySelectorAll(".btn-clear");
        // Nota: logoutButton es manejado por sidebar.js ahora

        // --- 2. FUNCIONES HELPER ---
        function formatearFecha(fechaString, paraInput = false) {
            if (!fechaString) return paraInput ? "" : "No registrado";
            const fecha = new Date(fechaString);
            if (isNaN(fecha)) return paraInput ? "" : "Fecha inv√°lida";

            if (paraInput) {
                const year = fecha.getFullYear();
                const month = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const day = fecha.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            } else {
                return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
        }

        function obtenerFoto(url, nombre) {
            if (url) return url;
            const nombreEncoded = encodeURIComponent(nombre);
            return `https://ui-avatars.com/api/?name=${nombreEncoded}&background=E2E8F0&color=2D3748`;
        }

        // --- 3. FUNCI√ìN PARA MOSTRAR DATOS (MODO VISUALIZACI√ìN) ---
        function mostrarDatos() {
            // Preparamos los datos a mostrar
            const nombreCompleto = `${usuario.nombre} ${usuario.apellido}`;
            const puestoUsuario = usuario.puesto || (usuario.esSupervisor ? "Supervisor" : "Empleado");
            const fotoUrl = obtenerFoto(usuario.fotoUrl, nombreCompleto);

            // Rellenar Perfil Principal (Avatar, Nombre, Rol en <main>)
            spans.profileName.textContent = nombreCompleto;
            spans.profileRole.textContent = puestoUsuario;
            spans.profileImg.src = fotoUrl;
            spans.profileImg.alt = `Foto de ${nombreCompleto}`;

            // Rellenar Tarjetas de Datos
            if (spans.nombre) spans.nombre.textContent = usuario.nombre;
            if (spans.apellido) spans.apellido.textContent = usuario.apellido;
            spans.dni.textContent = usuario.dni || "No registrado";
            spans.nacimiento.textContent = formatearFecha(usuario.fechaNacimiento);
            spans.telefono.textContent = usuario.telefono || "No registrado";
            spans.correo.textContent = usuario.correoEmpresarial;
            spans.puesto.textContent = puestoUsuario; // Muestra el puesto calculado
            spans.estado.textContent = usuario.estado || "No registrado";
            spans.ingreso.textContent = formatearFecha(usuario.fechaIngreso);
            spans.tiempo.textContent = usuario.tiempoTrabajo || "No registrado";
            spans.contrato.textContent = usuario.esContrato || "No registrado";

            // Gesti√≥n de visibilidad: Ocultar edici√≥n, mostrar visualizaci√≥n
            document.querySelectorAll('.edit-field, .edit-container').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.data-item p').forEach(el => el.style.display = 'block'); // Muestra los p√°rrafos

            // Botones: Mostrar Editar, ocultar Guardar/Cancelar
            btnStartEdit.style.display = 'inline-block';
            btnSaveEdit.style.display = 'none';
            btnCancelEdit.style.display = 'none';
        }

        // --- 4. FUNCI√ìN PARA ENTRAR EN MODO EDICI√ìN ---
        function iniciarEdicion() {
            // Rellenar inputs con datos actuales del objeto 'usuario'
            inputs.nombre.value = usuario.nombre;
            inputs.apellido.value = usuario.apellido;
            inputs.nacimiento.value = formatearFecha(usuario.fechaNacimiento, true);
            inputs.telefono.value = usuario.telefono || "";
            inputs.puesto.value = usuario.puesto || "";
            inputs.tiempo.value = usuario.tiempoTrabajo || "";
            inputs.contrato.value = usuario.esContrato || "";
            inputs.fotoUrl.value = usuario.fotoUrl || "";

            // Gesti√≥n de visibilidad: Mostrar edici√≥n, ocultar visualizaci√≥n
            document.querySelectorAll('.edit-field, .edit-container').forEach(el => el.style.display = 'flex'); // Muestra contenedores de edici√≥n
            document.querySelectorAll('.data-item p').forEach(el => el.style.display = 'none'); // Oculta los p√°rrafos
            document.querySelectorAll('.data-item > input.edit-field').forEach(el => el.style.display = 'block'); // Muestra inputs directos

            // Botones: Ocultar Editar, mostrar Guardar/Cancelar
            btnStartEdit.style.display = 'none';
            btnSaveEdit.style.display = 'inline-block';
            btnCancelEdit.style.display = 'inline-block';
        }

        // --- 5. FUNCI√ìN PARA GUARDAR CAMBIOS ---
        async function guardarCambios() {
            // Construir objeto con datos actualizados desde los inputs
            const datosActualizados = {
                nombre: inputs.nombre.value.trim(),
                apellido: inputs.apellido.value.trim(),
                fechaNacimiento: inputs.nacimiento.value ? inputs.nacimiento.value : null,
                telefono: inputs.telefono.value.trim() ? inputs.telefono.value.trim() : null,
                puesto: inputs.puesto.value.trim() ? inputs.puesto.value.trim() : null,
                tiempoTrabajo: inputs.tiempo.value.trim() ? inputs.tiempo.value.trim() : null,
                esContrato: inputs.contrato.value.trim() ? inputs.contrato.value.trim() : null,
                fotoUrl: inputs.fotoUrl.value.trim() ? inputs.fotoUrl.value.trim() : null,
                // Incluir IDs y campos no editables que el backend pueda necesitar
                idEmpleado: usuario.idEmpleado || null,
                idSupervisor: usuario.idSupervisor || null,
                correoEmpresarial: usuario.correoEmpresarial,
                dni: usuario.dni,
            };

            // Determinar el endpoint correcto
            let endpoint = '';
            const API_BASE_URL = "http://localhost:8085"; // Aseg√∫rate que sea tu URL base
            if (usuario.esSupervisor) {
                endpoint = `${API_BASE_URL}/api/supervisores/${usuario.idSupervisor}`; // Necesita crearse en backend
            } else {
                endpoint = `${API_BASE_URL}/api/empleados/${usuario.idEmpleado}`; // Necesita crearse/modificarse en backend
            }

            // --- LLAMADA A LA API ---
            try {
                btnSaveEdit.disabled = true;
                btnSaveEdit.textContent = "Guardando...";

                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosActualizados)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }

                const usuarioActualizado = await response.json();
                // IMPORTANTE: Asegurarse que el backend devuelva el objeto completo actualizado
                // incluyendo la bandera 'esSupervisor' que usamos en el login
                usuarioActualizado.esSupervisor = usuario.esSupervisor;

                // Actualizar sessionStorage y la variable local 'usuario'
                sessionStorage.setItem("usuarioLogueado", JSON.stringify(usuarioActualizado));
                usuario = usuarioActualizado;

                alert("Perfil actualizado correctamente.");
                mostrarDatos(); // Vuelve al modo visualizaci√≥n

                // Forzar a sidebar.js a recargar el nombre/foto si cambiaron
                // (La forma m√°s simple es recargar la p√°gina)
                window.location.reload();

            } catch (error) {
                console.error("Error al guardar cambios:", error);
                alert(`No se pudo actualizar el perfil: ${error.message}\nAseg√∫rate de que los endpoints PUT existan en el backend.`);
            } finally {
                btnSaveEdit.disabled = false;
                btnSaveEdit.textContent = "Guardar Cambios";
            }
        }

        // --- 6. EVENT LISTENERS ---
        btnStartEdit.addEventListener("click", iniciarEdicion);
        btnCancelEdit.addEventListener("click", mostrarDatos);
        btnSaveEdit.addEventListener("click", guardarCambios);

        // Listener para los botones de borrar (üóëÔ∏è)
        btnClearFields.forEach(button => {
            button.addEventListener("click", () => {
                const inputId = button.dataset.input; // Obtiene 'nacimiento' o 'telefono'
                // Busca el input por el ID completo 'edit-nacimiento' o 'edit-telefono'
                const targetInput = document.getElementById(`edit-${inputId}`);
                if (targetInput) {
                    targetInput.value = ""; // Limpia el valor del input
                }
            });
        });

        // Nota: El listener de Logout ahora est√° en sidebar.js

        // --- 7. CARGA INICIAL ---
        mostrarDatos(); // Llama a mostrarDatos para llenar la p√°gina al cargar

    });
</script>
</body>
</html>